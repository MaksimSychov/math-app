name: Java CI/CD

on: [push, pull_request]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: [17, 21]

    steps:
      - uses: actions/checkout@v4

      - name: Установка Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Запуск тестов
        run: mvn test

  build:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Установка Java
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Сборка проекта
        run: mvn clean compile

      - name: Создание JAR
        run: mvn package -DskipTests

      - name: Проверка сборки
        run: |
          echo "Проверяем собранные файлы:"
          ls -la target/
          echo "Запускаем приложение:"
          java -cp target/math-app-1.0.jar MathOperations

      - name: Сохранение JAR файла
        uses: actions/upload-artifact@v4
        with:
          name: math-app-jar
          path: target/math-app-1.0.jar

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Скачать JAR файл
        uses: actions/download-artifact@v4
        with:
          name: math-app-jar

      - name: Проверка файла
        run: |
          echo "Скачанные файлы:"
          ls -la
          echo "Запуск приложения:"
          java -cp math-app-1.0.jar MathOperations

      - name: Создание тегового релиза
        run: |
          echo "Создание релиза для версии v1.0.${{ github.run_number }}"
          echo "Сборка: ${{ github.sha }}"
          echo "Дата: ${{ github.event.head_commit.timestamp }}"

#  Если деплой на Heroku
#  deploy-heroku:
#    runs-on: ubuntu-latest
#    needs: build
#    if: github.ref == 'refs/heads/main'
#
#    steps:
#      - name: Скачать JAR
#        uses: actions/download-artifact@v4
#        with:
#          name: math-app
#
#      - name: Деплой на Heroku
#        uses: akhileshns/heroku-deploy@v3.12.12
#        with:
#          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
#          heroku_app_name: "math-app"
#          heroku_email: "test@example.com"
#          usedocker: false
